# This file autogenerated by Chef
# Do not edit, changes will be overwritten

LoadPlugin dbi

<Plugin dbi>
  <Query "free_dm">
     Statement "SELECT node_id, (total - used) AS free FROM memoryusage WHERE memory_type LIKE 'Data memory'"
      # Use with MySQL 5.0.0 or later
      MinVersion 50000
    <Result>
      Type "gauge"
      InstancePrefix "free_data_memory"
      InstancesFrom "node_id"
      ValuesFrom "free"
    </Result>
  </Query>

  <Query "free_im">
     Statement "SELECT node_id, (total - used) AS free FROM memoryusage WHERE memory_type LIKE 'Index memory'"
      # Use with MySQL 5.0.0 or later
      MinVersion 50000
    <Result>
      Type "gauge"
      InstancePrefix "free_index_memory"
      InstancesFrom "node_id"
      ValuesFrom "free"
    </Result>
  </Query>

  <Query "total_dm">
     Statement "SELECT node_id, total FROM memoryusage WHERE memory_type LIKE 'Data memory'"
      # Use with MySQL 5.0.0 or later
      MinVersion 50000
    <Result>
      Type "gauge"
      InstancePrefix "total_data_memory"
      InstancesFrom "node_id"
      ValuesFrom "total"
    </Result>
  </Query>
  <Query "total_im">
    Statement "SELECT node_id, total FROM ndbinfo.memoryusage where memory_type LIKE 'Index memory'"
      # Use with MySQL 5.0.0 or later
      MinVersion 50000
    <Result>
      Type "gauge"
      InstancePrefix "total_index_memory"
      InstancesFrom "node_id"
      ValuesFrom "total"
    </Result>
  </Query>

  <Query "counters">
    Statement "SELECT counter_name, SUM(val) as sum FROM counters WHERE counter_name IN ('READS', 'SIMPLE_READS', 'WRITES', 'TABLE_SCANS', 'RANGE_SCANS') GROUP BY counter_name ;"
      # Use with MySQL 5.0.0 or later
      MinVersion 50000
    <Result>
      Type "derive"
      InstancePrefix "rate_counters_sum"
      InstancesFrom "counter_name"
      ValuesFrom "sum"
    </Result>
  </Query>

  <Database "ndbinfo">
    Driver "mysql"
# This seems to work
    DriverOption "mysql_unix_socket" "<%= node[:ndb][:mysql_socket] %>"
    DriverOption "username" "root"
#    DriverOption "password" "<%= node[:mysql][:root][:password] %>"
# note: 'host' doesn't seem to work for some reason
#    DriverOption "host" "<%= @mysql_ip %>"
#    DriverOption "host" "localhost"
    DriverOption "dbname" "ndbinfo"
    SelectDB "ndbinfo"
    Query "free_dm"
    Query "free_im"
    Query "total_dm"
    Query "total_im"
    QUERY "counters"
  </Database>

</Plugin>
